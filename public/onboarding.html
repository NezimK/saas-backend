<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - IMMO Copilot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --accent: #C5A065;
            --accent-dark: #B08F55;
            --dark-bg: #0F0F0F;
            --dark-card: #1A1A1A;
            --gray-900: #111111;
            --gray-800: #1f1f1f;
            --gray-700: #2a2a2a;
            --gray-600: #3a3a3a;
            --gray-500: #6b7280;
            --gray-400: #9ca3af;
            --gray-300: #d1d5db;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--gray-900) 0%, var(--dark-bg) 50%, var(--gray-900) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Arriere-plan decoratif */
        body::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 5%;
            width: 300px;
            height: 300px;
            background: rgba(197, 160, 101, 0.05);
            border-radius: 50%;
            filter: blur(80px);
            pointer-events: none;
        }

        body::after {
            content: '';
            position: absolute;
            bottom: 10%;
            right: 5%;
            width: 400px;
            height: 400px;
            background: rgba(197, 160, 101, 0.08);
            border-radius: 50%;
            filter: blur(100px);
            pointer-events: none;
        }

        .container {
            background: var(--dark-card);
            border: 1px solid var(--gray-700);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 32px;
            font-weight: 700;
        }

        .logo h1 .accent {
            color: var(--accent);
        }

        .logo h1 .white {
            color: white;
            margin-left: 8px;
        }

        .subtitle {
            color: var(--gray-400);
            margin-bottom: 30px;
            font-size: 15px;
            text-align: center;
        }

        .welcome-name {
            color: var(--accent);
            font-weight: 600;
        }

        h2 {
            color: var(--accent);
            margin-top: 20px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gray-700);
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: var(--accent);
            box-shadow: 0 0 10px rgba(197, 160, 101, 0.4);
        }

        .portals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .portal-card {
            border: 1px solid var(--gray-700);
            background: var(--gray-900);
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .portal-card:hover {
            border-color: var(--accent);
            background: rgba(197, 160, 101, 0.05);
        }

        .portal-card.selected {
            border-color: var(--accent);
            background: rgba(197, 160, 101, 0.1);
        }

        .portal-card input[type="checkbox"] {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .portal-name {
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            font-size: 16px;
        }

        .portal-domain {
            color: var(--gray-500);
            font-size: 13px;
        }

        .btn-container {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: black;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent) 100%);
            transform: scale(1.02);
        }

        .btn-primary:disabled {
            background: var(--gray-700);
            color: var(--gray-500);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--gray-800);
            color: var(--gray-300);
            border: 1px solid var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-700);
            color: white;
        }

        .logiciel-choice.active {
            border-color: var(--accent);
            background: rgba(197, 160, 101, 0.1);
            color: var(--accent);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-size: 14px;
        }

        .success {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid rgba(34, 197, 94, 0.3);
            font-size: 14px;
        }

        .count {
            color: var(--accent);
            font-weight: 600;
        }

        .info-box {
            background: var(--gray-900);
            border: 1px solid var(--gray-700);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .info-box h3 {
            color: var(--accent);
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .info-box ol {
            margin-left: 20px;
            color: var(--gray-400);
        }

        .info-box li {
            margin-bottom: 10px;
            line-height: 1.6;
            font-size: 14px;
        }

        .info-box li strong {
            color: var(--gray-300);
        }

        .info-box a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .info-box code {
            background: var(--dark-card);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--accent);
            font-size: 13px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-300);
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--gray-700);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            background: var(--gray-900);
            color: white;
            transition: all 0.2s ease;
        }

        .input-group input::placeholder {
            color: var(--gray-500);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(197, 160, 101, 0.1);
        }

        .help-text {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 6px;
        }

        /* Loading state */
        .loading-container {
            text-align: center;
            padding: 40px 0;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--gray-700);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--gray-400);
            font-size: 15px;
        }

        /* Error state */
        .error-container {
            text-align: center;
            padding: 40px 0;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 25px;
            color: var(--gray-500);
            font-size: 13px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            .portals-grid {
                grid-template-columns: 1fr;
            }

            .btn-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">
            <h1>
                <span class="accent">IMMO</span><span class="white">Copilot</span>
            </h1>
        </div>

        <!-- Loading State -->
        <div id="loadingState">
            <div class="loading-container">
                <div class="spinner"></div>
                <p class="loading-text">Chargement de votre configuration...</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;">
            <div class="error-container">
                <div class="error-icon">&#10060;</div>
                <p class="subtitle" id="errorMessage">Une erreur est survenue</p>
                <p class="help-text">Veuillez contacter le support ou reessayer.</p>
            </div>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="mainContent" style="display: none;">
            <p class="subtitle" id="welcomeMessage">
                Bonjour <span class="welcome-name" id="companyNameDisplay"></span> !<br>
                Configurez votre compte IMMO Copilot.
            </p>

            <!-- Indicateur d'etapes (3 etapes: Logiciel, Portails, Email) -->
            <div class="step-indicator">
                <div class="step-dot" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
                <div class="step-dot" id="dot3"></div>
            </div>

            <div id="error" class="error"></div>
            <div id="success" class="success"></div>

            <!-- Etape 1: Choix du logiciel + Configuration API -->
            <div id="logicielStep">
                <p class="subtitle" style="margin-bottom: 20px;">Quel logiciel immobilier utilisez-vous ?</p>

                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button class="btn btn-secondary logiciel-choice active" id="choiceNetty" onclick="selectLogiciel('netty')" style="flex: 1; padding: 16px; text-align: center;">
                        <strong>Septeo</strong>
                    </button>
                    <button class="btn btn-secondary logiciel-choice" id="choiceApimo" onclick="selectLogiciel('apimo')" style="flex: 1; padding: 16px; text-align: center;">
                        <strong>Apimo</strong>
                    </button>
                </div>

                <!-- Formulaire Netty -->
                <div id="nettyForm">
                    <div class="info-box">
                        <h3>Comment recuperer votre cle API Septeo ?</h3>
                        <ol>
                            <li><strong>Allez dans Septeo :</strong> Parametres → Configuration → Gestion des cles API</li>
                            <li><strong>Cliquez sur "+ NOUVEAU"</strong></li>
                            <li><strong>Remplir le formulaire :</strong>
                                <ul style="margin-top: 8px; margin-left: 20px; list-style-type: disc;">
                                    <li>Nom de l'accès API : "IMMO Copilot"</li>
                                    <li>Clé associée à des : Données Réelles</li>
                                    <li>Active : Oui</li>
                                    <li>IP autorisees : <code>51.178.42.123</code></li>
                                </ul>
                            </li>
                            <li><strong>Copiez la cle API</strong> generee et collez-la ci-dessous</li>
                        </ol>
                        <p style="margin-top: 15px;">
                            <a href="https://aide.netty.fr/gestion-cles-api-modelo-office" target="_blank">
                                Voir le guide visuel complet
                            </a>
                        </p>
                    </div>

                    <div class="input-group">
                        <label for="apiKeyInput">Votre cle API Septeo</label>
                        <input type="text" id="apiKeyInput" placeholder="Collez votre cle API ici"
                            onkeypress="if(event.key === 'Enter') validateNettyAPI()">
                        <div class="help-text">Cette cle permet a IMMO Copilot de synchroniser vos biens automatiquement
                        </div>
                        <p class="help-text" style="margin-top: 12px; color: var(--gray-400);">
                            Vous ne trouvez pas votre cle API ? Contactez le support de votre CRM.
                        </p>
                    </div>

                    <button class="btn btn-primary" id="validateNettyBtn" onclick="validateNettyAPI()">
                        Valider et continuer
                    </button>
                </div>

                <!-- Formulaire Apimo -->
                <div id="apimoForm" style="display: none;">
                    <div class="info-box">
                        <h3>Comment obtenir vos identifiants API Apimo ?</h3>
                        <ol>
                            <li><strong>Contactez le support Apimo</strong> pour demander un acces API :
                                <ul style="margin-top: 8px; margin-left: 20px; list-style-type: disc;">
                                    <li>Par telephone : <code>+33 (0)4 92 91 90 63</code></li>
                                    <li>Par email via le <a href="https://apimo.net/en/contact" target="_blank">formulaire de contact Apimo</a></li>
                                    <li>Par WhatsApp : <code>+33 4 92 91 90 63</code></li>
                                </ul>
                            </li>
                            <li><strong>Demandez un acces "Webservice API"</strong> en precisant que vous souhaitez connecter votre compte a IMMO Copilot</li>
                            <li><strong>Vous recevrez 3 informations :</strong>
                                <ul style="margin-top: 8px; margin-left: 20px; list-style-type: disc;">
                                    <li><strong>Provider ID</strong> — identifiant numerique (ex: <code>1234</code>)</li>
                                    <li><strong>Token</strong> — cle d'authentification (longue chaine de caracteres)</li>
                                    <li><strong>Agency ID</strong> — identifiant de votre agence (ex: <code>56789</code>)</li>
                                </ul>
                            </li>
                            <li><strong>Saisissez ces 3 informations</strong> dans les champs ci-dessous</li>
                        </ol>
                        <p style="margin-top: 15px;">
                            <a href="https://apimo.net/en/api/" target="_blank">
                                En savoir plus sur l'API Apimo
                            </a>
                        </p>
                    </div>

                    <div class="input-group">
                        <label for="apimoProviderInput">Provider ID</label>
                        <input type="text" id="apimoProviderInput" placeholder="Ex: 1234"
                            onkeypress="if(event.key === 'Enter') document.getElementById('apimoTokenInput').focus()">
                        <div class="help-text">Identifiant numerique fourni par Apimo</div>
                    </div>

                    <div class="input-group">
                        <label for="apimoTokenInput">Token</label>
                        <input type="text" id="apimoTokenInput" placeholder="Collez votre token ici"
                            onkeypress="if(event.key === 'Enter') document.getElementById('apimoAgencyInput').focus()">
                        <div class="help-text">Cle d'authentification fournie par Apimo</div>
                    </div>

                    <div class="input-group">
                        <label for="apimoAgencyInput">Agency ID</label>
                        <input type="text" id="apimoAgencyInput" placeholder="Ex: 56789"
                            onkeypress="if(event.key === 'Enter') validateApimoAPI()">
                        <div class="help-text">Identifiant de votre agence dans Apimo</div>
                    </div>

                    <p class="help-text" style="margin-bottom: 20px; color: var(--gray-400);">
                        Vous n'avez pas encore vos identifiants ? Contactez le support Apimo au <strong style="color: var(--gray-300);">04 92 91 90 63</strong>
                    </p>

                    <button class="btn btn-primary" id="validateApimoBtn" onclick="validateApimoAPI()">
                        Valider et continuer
                    </button>
                </div>
            </div>

            <!-- Etape 2: Selection des portails -->
            <div id="portalsStep" style="display: none;">
                <p class="subtitle" style="margin-bottom: 20px;">Selectionnez les portails immobiliers dont vous
                    souhaitez recevoir les notifications</p>

                <div class="portals-grid" id="portalsGrid">
                    <!-- Les portails seront ajoutes dynamiquement -->
                </div>

                <p style="margin-bottom: 20px; color: var(--gray-400); font-size: 14px;">
                    <span class="count" id="selectedCount">0</span> portail(s) selectionne(s)
                </p>

                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="selectAll()">Tout selectionner</button>
                    <button class="btn btn-primary" id="continueBtn" onclick="saveAndContinue()" disabled>
                        Connectez votre boite mail
                    </button>
                </div>
            </div>

            <!-- Etape 3: Email OAuth (Gmail ou Outlook) -->
            <div id="gmailStep" style="display: none;">
                <p class="subtitle" style="margin-bottom: 20px;">Connexion a votre boite mail</p>

                <div class="info-box">
                    <h3>Pourquoi connecter ma boite mail ?</h3>
                    <p style="color: var(--gray-400); line-height: 1.6;">
                        IMMO Copilot a besoin d'acceder a votre boite mail pour detecter automatiquement
                        les notifications des portails immobiliers et extraire les informations de contact.
                    </p>
                    <p style="color: var(--gray-400); margin-top: 15px; line-height: 1.6;">
                        <strong style="color: var(--gray-300);">Nous respectons votre vie privee :</strong>
                        Seuls les emails provenant des portails selectionnes sont analyses.
                    </p>
                </div>

                <div style="display: flex; gap: 12px; flex-direction: column;">
                    <button class="btn btn-primary" onclick="connectGmail()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/>
                        </svg>
                        Connecter Gmail
                    </button>
                    <button class="btn btn-secondary" onclick="connectOutlook()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7.88 12.04q0 .45-.11.87-.1.41-.33.74-.22.33-.58.52-.37.2-.87.2t-.85-.2q-.35-.21-.57-.55-.22-.33-.33-.75-.1-.42-.1-.86t.1-.87q.1-.43.34-.76.22-.34.59-.54.36-.2.87-.2t.86.2q.35.21.57.55.22.34.31.77.1.43.1.88zM24 12v9.38q0 .46-.33.8-.33.32-.8.32H7.13q-.46 0-.8-.33-.32-.33-.32-.8V18H1q-.41 0-.7-.3-.3-.29-.3-.7V7q0-.41.3-.7Q.58 6 1 6h6.5V2.55q0-.44.3-.75.3-.3.75-.3h12.9q.44 0 .75.3.3.3.3.75V12zm-6-8.25v3h3v-3zm0 4.5v3h3v-3zm0 4.5v1.83l3.05-1.83zm-5.25-9v3h3.75v-3zm0 4.5v3h3.75v-3zm0 4.5v2.03l2.41 1.5 1.34-.8v-2.73zM9 3.75V6h2l.13.01.12.04v-2.3zM5.98 15.98q.9 0 1.6-.3.7-.32 1.19-.86.48-.55.73-1.28.25-.74.25-1.61 0-.83-.25-1.55-.24-.71-.71-1.24t-1.15-.83q-.68-.3-1.55-.3-.92 0-1.64.3-.71.3-1.2.85-.5.54-.75 1.3-.25.74-.25 1.63 0 .85.26 1.56.26.72.74 1.23.48.52 1.17.81.69.3 1.56.3zM7.5 21h12.39L12 16.08V17q0 .41-.3.7-.29.3-.7.3H7.5zm15-.13v-7.24l-5.9 3.54Z"/>
                        </svg>
                        Connecter Outlook / Microsoft 365
                    </button>
                </div>
            </div>


            <div class="footer">
                &copy; 2026 EMKAI - IMMO Copilot
            </div>
        </div>
    </div>

    <script>
        const portals = [
            { name: 'Leboncoin', domain: 'leboncoin.fr', icon: '' },
            { name: 'SeLoger', domain: 'seloger.com', icon: '' },
            { name: 'PAP', domain: 'pap.fr', icon: '' },
            { name: 'Logic-Immo', domain: 'logic-immo.com', icon: '' },
            { name: "Bien'ici", domain: 'bienici.com', icon: '' },
            { name: 'Figaro Immo', domain: 'figaroimmo.fr', icon: '' },
            { name: 'ParuVendu', domain: 'paruvendu.fr', icon: '' },
            { name: 'Ouest-France Immo', domain: 'ouestfrance-immo.com', icon: '' }
        ];

        let tenantId = null;
        let tenantData = null;
        let currentStep = 1;

        // Recuperer les parametres depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        tenantId = urlParams.get('tenantId');
        const gmailSuccess = urlParams.get('gmail_success');
        const outlookSuccess = urlParams.get('outlook_success');

        // Token d'onboarding pour authentifier les requetes
        const onboardingToken = localStorage.getItem('onboardingToken');
        function authHeaders(extra = {}) {
            return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${onboardingToken}`, ...extra };
        }

        // Elements du DOM
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const mainContent = document.getElementById('mainContent');
        const errorMessage = document.getElementById('errorMessage');
        const companyNameDisplay = document.getElementById('companyNameDisplay');

        // Initialisation au chargement
        async function initOnboarding() {
            if (!tenantId) {
                showErrorState('Lien invalide. Veuillez utiliser le lien recu par email.');
                return;
            }

            // Si Gmail ou Outlook OAuth a reussi, finaliser l'onboarding
            if (gmailSuccess === 'true' || outlookSuccess === 'true') {
                await completeOnboardingAfterEmail();
                return;
            }

            try {
                // Charger les infos du tenant
                const response = await fetch(`/api/onboarding/tenant/${tenantId}`, { headers: authHeaders() });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    showErrorState(data.error || 'Tenant non trouve');
                    return;
                }

                tenantData = data.tenant;

                // Afficher le nom de l'entreprise
                companyNameDisplay.textContent = tenantData.company_name || 'Utilisateur';

                // Masquer le loading, afficher le contenu
                loadingState.style.display = 'none';
                mainContent.style.display = 'block';

                // Mettre a jour l'indicateur d'etapes
                updateStepIndicator();

            } catch (error) {
                console.error('Erreur initialisation:', error);
                showErrorState('Erreur de connexion au serveur');
            }
        }

        // Finaliser l'onboarding et rediriger vers le dashboard
        async function completeOnboarding() {
            try {
                loadingState.querySelector('.loading-text').textContent = 'Finalisation de votre compte...';

                const response = await fetch('/api/onboarding/complete', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ tenantId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la finalisation');
                }

                // Afficher message de succes
                loadingState.querySelector('.loading-text').textContent = 'Configuration terminee ! Redirection vers le dashboard...';

                // Rediriger vers le dashboard apres 2 secondes
                setTimeout(() => {
                    window.location.href = data.dashboardUrl;
                }, 2000);

            } catch (error) {
                console.error('Erreur finalisation:', error);
                showErrorState('Erreur lors de la finalisation. Veuillez reessayer.');
            }
        }

        function showErrorState(message) {
            loadingState.style.display = 'none';
            mainContent.style.display = 'none';
            errorState.style.display = 'block';
            errorMessage.textContent = message;
        }

        // Finaliser l'onboarding apres connexion email reussie
        async function completeOnboardingAfterEmail() {
            try {
                // Charger les infos du tenant
                const response = await fetch(`/api/onboarding/tenant/${tenantId}`, { headers: authHeaders() });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    showErrorState(data.error || 'Tenant non trouve');
                    return;
                }

                tenantData = data.tenant;
                companyNameDisplay.textContent = tenantData.company_name || 'Utilisateur';

                // Masquer le loading, afficher le contenu
                loadingState.style.display = 'none';
                mainContent.style.display = 'block';

                // Cacher toutes les etapes
                document.getElementById('logicielStep').style.display = 'none';
                document.getElementById('portalsStep').style.display = 'none';
                document.getElementById('gmailStep').style.display = 'none';

                currentStep = 3;
                updateStepIndicator();

                showSuccess('Connexion email reussie ! Finalisation de votre compte...');

                // Finaliser l'onboarding directement
                setTimeout(() => {
                    completeOnboarding();
                }, 1500);

            } catch (error) {
                console.error('Erreur:', error);
                showErrorState('Erreur de connexion au serveur');
            }
        }

        // Mettre a jour l'indicateur d'etapes (3 etapes)
        function updateStepIndicator() {
            document.getElementById('dot1').classList.toggle('active', currentStep >= 1);
            document.getElementById('dot2').classList.toggle('active', currentStep >= 2);
            document.getElementById('dot3').classList.toggle('active', currentStep >= 3);
        }

        async function validateNettyAPI() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                showError('Veuillez entrer votre cle API Septeo');
                return;
            }

            if (!tenantId) {
                showError('Erreur: tenant non initialise');
                return;
            }

            const btn = document.getElementById('validateNettyBtn');
            btn.disabled = true;
            btn.textContent = 'Validation en cours...';

            try {
                const response = await fetch('/api/onboarding/validate-netty-api', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ tenantId, apiKey })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la validation de la clée API');
                }

                showSuccess('Cle API Septeo validee avec succes !');

                // Passer a l'etape portails apres 1 seconde
                setTimeout(() => {
                    document.getElementById('logicielStep').style.display = 'none';
                    document.getElementById('portalsStep').style.display = 'block';
                    currentStep = 2;
                    updateStepIndicator();
                    renderPortals([]);
                    // Scroll vers le haut de l'etape
                    document.getElementById('portalsStep').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 1000);

            } catch (error) {
                showError(error.message);
                btn.disabled = false;
                btn.textContent = 'Valider et continuer';
            }
        }

        // Selectionner le logiciel (Netty ou Apimo)
        let selectedLogiciel = 'netty';
        function selectLogiciel(logiciel) {
            selectedLogiciel = logiciel;
            document.getElementById('nettyForm').style.display = logiciel === 'netty' ? 'block' : 'none';
            document.getElementById('apimoForm').style.display = logiciel === 'apimo' ? 'block' : 'none';
            document.getElementById('choiceNetty').classList.toggle('active', logiciel === 'netty');
            document.getElementById('choiceApimo').classList.toggle('active', logiciel === 'apimo');
        }

        // Valider les credentials API Apimo
        async function validateApimoAPI() {
            const providerId = document.getElementById('apimoProviderInput').value.trim();
            const token = document.getElementById('apimoTokenInput').value.trim();
            const agencyId = document.getElementById('apimoAgencyInput').value.trim();

            if (!providerId || !token || !agencyId) {
                showError('Veuillez remplir les 3 champs (Provider ID, Token, Agency ID)');
                return;
            }

            if (!tenantId) {
                showError('Erreur: tenant non initialise');
                return;
            }

            const btn = document.getElementById('validateApimoBtn');
            btn.disabled = true;
            btn.textContent = 'Validation en cours...';

            try {
                const response = await fetch('/api/onboarding/validate-apimo-api', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ tenantId, providerId, token, agencyId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la validation des credentials');
                }

                showSuccess('Credentials API Apimo validees avec succes !');

                // Passer a l'etape portails apres 1 seconde
                setTimeout(() => {
                    document.getElementById('logicielStep').style.display = 'none';
                    document.getElementById('portalsStep').style.display = 'block';
                    currentStep = 2;
                    updateStepIndicator();
                    renderPortals([]);
                    document.getElementById('portalsStep').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 1000);

            } catch (error) {
                showError(error.message);
                btn.disabled = false;
                btn.textContent = 'Valider et continuer';
            }
        }

        function renderPortals(existingFilters = []) {
            const grid = document.getElementById('portalsGrid');
            grid.innerHTML = portals.map((portal, index) => `
                <div class="portal-card" id="card-${index}" onclick="togglePortal(${index})">
                    <input type="checkbox" id="portal-${index}" onchange="updateSelection()">
                    <div class="portal-name">${portal.name}</div>
                    <div class="portal-domain">${portal.domain}</div>
                </div>
            `).join('');

            if (existingFilters.length > 0) {
                portals.forEach((portal, i) => {
                    if (existingFilters.includes(portal.domain)) {
                        document.getElementById(`portal-${i}`).checked = true;
                        document.getElementById(`card-${i}`).classList.add('selected');
                    }
                });
            } else {
                // Selectionner les 5 premiers par defaut
                [0, 1, 2, 3, 4].forEach(i => {
                    document.getElementById(`portal-${i}`).checked = true;
                    document.getElementById(`card-${i}`).classList.add('selected');
                });
            }
            updateSelection();
        }

        function togglePortal(index) {
            const checkbox = document.getElementById(`portal-${index}`);
            const card = document.getElementById(`card-${index}`);

            checkbox.checked = !checkbox.checked;
            card.classList.toggle('selected', checkbox.checked);
            updateSelection();
        }

        function updateSelection() {
            const selected = portals.filter((_, i) =>
                document.getElementById(`portal-${i}`)?.checked
            ).length;

            document.getElementById('selectedCount').textContent = selected;
            document.getElementById('continueBtn').disabled = selected === 0;
        }

        function selectAll() {
            portals.forEach((_, i) => {
                document.getElementById(`portal-${i}`).checked = true;
                document.getElementById(`card-${i}`).classList.add('selected');
            });
            updateSelection();
        }

        async function saveAndContinue() {
            const selectedDomains = portals
                .filter((_, i) => document.getElementById(`portal-${i}`).checked)
                .map(p => p.domain);

            if (selectedDomains.length === 0) {
                showError('Veuillez selectionner au moins un portail');
                return;
            }

            if (!tenantId) {
                showError('Erreur: tenant non initialise');
                return;
            }

            document.getElementById('continueBtn').disabled = true;
            document.getElementById('continueBtn').textContent = 'Enregistrement...';

            try {
                const response = await fetch('/api/onboarding/update-filters', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        tenantId,
                        emailFilters: selectedDomains
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la sauvegarde');
                }

                showSuccess('Configuration enregistree !');

                // Passer a l'etape Gmail
                setTimeout(() => {
                    document.getElementById('portalsStep').style.display = 'none';
                    document.getElementById('gmailStep').style.display = 'block';
                    currentStep = 3;
                    updateStepIndicator();
                    // Scroll vers le haut de l'etape
                    document.getElementById('gmailStep').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 1000);

            } catch (error) {
                showError(error.message);
                document.getElementById('continueBtn').disabled = false;
                document.getElementById('continueBtn').textContent = 'Continuer vers Gmail';
            }
        }

        function connectGmail() {
            // Rediriger vers l'OAuth Gmail avec callback vers managerStep
            window.location.href = `/auth/gmail/connect?tenantId=${tenantId}`;
        }

        function connectOutlook() {
            // Rediriger vers l'OAuth Outlook avec callback vers managerStep
            window.location.href = `/auth/outlook/connect?tenantId=${tenantId}`;
        }


        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success').style.display = 'none';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }

        // Lancer l'initialisation au chargement
        initOnboarding();
    </script>
</body>

</html>